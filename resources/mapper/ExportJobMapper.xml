<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.pramaindia.login.mapper.ExportJobMapper">

    <resultMap id="ExportJobMap" type="com.pramaindia.login.model.entity.ExportJobEntity">
        <id property="id" column="id"/>
        <result property="userEmail" column="user_email"/>
        <result property="searchCriteria" column="search_criteria"/>
        <result property="filePath" column="file_path"/>
        <result property="fileName" column="file_name"/>
        <result property="status" column="status"/>
        <result property="errorMessage" column="error_message"/>
        <result property="createdTime" column="created_time"/>
        <result property="completedTime" column="completed_time"/>
        <result property="expiryTime" column="expiry_time"/>
        <result property="downloadCount" column="download_count"/>
    </resultMap>

    <sql id="Base_Column_List">
        id, user_email, search_criteria, file_path, file_name, status,
        error_message, created_time, completed_time, expiry_time, download_count
    </sql>

    <!-- Basic CRUD Operations -->
    <insert id="insertExportJob" parameterType="com.pramaindia.login.model.entity.ExportJobEntity">
        INSERT INTO export_job
        (id, user_email, search_criteria, status, created_time, expiry_time)
        VALUES
        (#{id}, #{userEmail}, #{searchCriteria}, #{status}, #{createdTime},
        DATEADD('HOUR', 24, #{createdTime}))
    </insert>

    <select id="selectExportJobById" resultMap="ExportJobMap">
        SELECT <include refid="Base_Column_List"/>
        FROM export_job WHERE id = #{id}
    </select>

    <select id="selectExportJobsByEmail" resultMap="ExportJobMap">
        SELECT <include refid="Base_Column_List"/>
        FROM export_job
        WHERE user_email = #{userEmail}
        ORDER BY created_time DESC
        <if test="limit != null">LIMIT #{limit}</if>
    </select>

    <!-- Update Operations -->
    <update id="updateExportJobStatus">
        UPDATE export_job
        SET status = #{status},
        error_message = #{errorMessage},
        file_path = #{filePath},
        file_name = #{fileName},
        completed_time = CASE
        WHEN #{status} = 'COMPLETED' THEN CURRENT_TIMESTAMP
        ELSE completed_time
        END,
        download_count = CASE
        WHEN #{status} = 'COMPLETED' THEN 0
        ELSE download_count
        END
        WHERE id = #{id}
    </update>

    <update id="updateExportJobFilePath">
        UPDATE export_job
        SET file_path = #{filePath},
        file_name = #{fileName},
        status = 'COMPLETED',
        completed_time = CURRENT_TIMESTAMP,
        expiry_time = DATEADD('HOUR', 24, CURRENT_TIMESTAMP)
        WHERE id = #{id}
    </update>

    <update id="updateExportJobError">
        UPDATE export_job
        SET status = 'FAILED',
        error_message = #{errorMessage},
        completed_time = CURRENT_TIMESTAMP
        WHERE id = #{id}
    </update>

    <update id="incrementDownloadCount">
        UPDATE export_job SET download_count = download_count + 1 WHERE id = #{id}
    </update>

    <update id="cancelExportJob">
        UPDATE export_job
        SET status = 'CANCELLED', completed_time = CURRENT_TIMESTAMP
        WHERE id = #{id} AND status = 'PENDING'
    </update>

    <update id="markJobAsProcessing">
        UPDATE export_job SET status = 'PROCESSING'
        WHERE id = #{id} AND status = 'PENDING'
    </update>

    <update id="extendExpiryTime">
        UPDATE export_job
        SET expiry_time = DATEADD('HOUR', 24, CURRENT_TIMESTAMP)
        WHERE id = #{id} AND status = 'COMPLETED'
    </update>

    <!-- Query Operations -->
    <select id="selectPendingJobs" resultMap="ExportJobMap">
        SELECT <include refid="Base_Column_List"/>
        FROM export_job
        WHERE status = 'PENDING'
        ORDER BY created_time ASC
        LIMIT #{limit}
    </select>

    <select id="selectExpiredJobs" resultMap="ExportJobMap">
        SELECT <include refid="Base_Column_List"/>
        FROM export_job
        WHERE status = 'COMPLETED'
        AND expiry_time &lt; CURRENT_TIMESTAMP
        AND download_count = 0
        ORDER BY expiry_time ASC
        LIMIT #{limit}
    </select>

    <select id="selectStaleProcessingJobs" resultMap="ExportJobMap">
        SELECT <include refid="Base_Column_List"/>
        FROM export_job
        WHERE status = 'PROCESSING'
        AND created_time &lt; DATEADD('MINUTE', -30, CURRENT_TIMESTAMP)
        ORDER BY created_time ASC
        LIMIT #{limit}
    </select>

    <select id="searchExportJobs" resultMap="ExportJobMap">
        SELECT <include refid="Base_Column_List"/>
        FROM export_job
        WHERE 1=1
        <if test="userEmail != null and userEmail != ''">
            AND user_email = #{userEmail}
        </if>
        <if test="status != null and status != ''">
            AND status = #{status}
        </if>
        <if test="startDate != null">
            AND DATE(created_time) &gt;= DATE(#{startDate})
        </if>
        <if test="endDate != null">
            AND DATE(created_time) &lt;= DATE(#{endDate})
        </if>
        ORDER BY created_time DESC
        <if test="limit != null">LIMIT #{limit}</if>
    </select>

    <select id="searchExportJobsWithPagination" resultMap="ExportJobMap">
        SELECT <include refid="Base_Column_List"/>
        FROM export_job
        WHERE 1=1
        <if test="userEmail != null and userEmail != ''">
            AND user_email = #{userEmail}
        </if>
        <if test="status != null and status != ''">
            AND status = #{status}
        </if>
        <if test="startDate != null">
            AND DATE(created_time) &gt;= DATE(#{startDate})
        </if>
        <if test="endDate != null">
            AND DATE(created_time) &lt;= DATE(#{endDate})
        </if>
        ORDER BY created_time DESC
        LIMIT #{limit} OFFSET #{offset}
    </select>

    <select id="searchExportJobsAdmin" resultMap="ExportJobMap">
        SELECT <include refid="Base_Column_List"/>
        FROM export_job
        WHERE 1=1
        <if test="userEmail != null and userEmail != ''">
            AND user_email LIKE CONCAT('%', #{userEmail}, '%')
        </if>
        <if test="status != null and status != ''">
            AND status = #{status}
        </if>
        <if test="startDate != null">
            AND DATE(created_time) &gt;= #{startDate}
        </if>
        <if test="endDate != null">
            AND DATE(created_time) &lt;= #{endDate}
        </if>
        ORDER BY created_time DESC
        LIMIT #{limit}
    </select>

    <!-- Statistics Operations -->
    <select id="countJobsByStatus" resultType="map">
        SELECT status, COUNT(*) as count
        FROM export_job GROUP BY status
    </select>

    <select id="getExportStats" resultType="map">
        SELECT
        DATE(created_time) as export_date,
        COUNT(*) as total_jobs,
        SUM(CASE WHEN status = 'COMPLETED' THEN 1 ELSE 0 END) as completed_jobs,
        SUM(CASE WHEN status = 'FAILED' THEN 1 ELSE 0 END) as failed_jobs,
        SUM(download_count) as total_downloads
        FROM export_job
        WHERE created_time &gt;= DATEADD('DAY', -30, CURRENT_TIMESTAMP)
        GROUP BY DATE(created_time)
        ORDER BY export_date DESC
    </select>

    <select id="getTopUsersByExports" resultType="map">
        SELECT
        user_email,
        COUNT(*) as export_count,
        SUM(CASE WHEN status = 'COMPLETED' THEN 1 ELSE 0 END) as completed_exports,
        MAX(created_time) as last_export_time
        FROM export_job
        WHERE created_time &gt;= DATEADD('DAY', -90, CURRENT_TIMESTAMP)
        GROUP BY user_email
        ORDER BY export_count DESC
        LIMIT 10
    </select>

    <select id="getFailedJobsWithRetryCount" resultMap="ExportJobMap">
        SELECT <include refid="Base_Column_List"/>
        FROM export_job
        WHERE status = 'FAILED'
        AND created_time &gt;= DATEADD('HOUR', -1, CURRENT_TIMESTAMP)
        ORDER BY created_time ASC
        LIMIT #{limit}
    </select>

    <!-- Cleanup Operations -->
    <delete id="deleteOldJobs">
        DELETE FROM export_job
        WHERE
        (status = 'COMPLETED' AND expiry_time &lt; DATEADD('DAY', -7, CURRENT_TIMESTAMP))
        OR (status IN ('FAILED', 'CANCELLED') AND created_time &lt; DATEADD('DAY', -30, CURRENT_TIMESTAMP))
    </delete>

</mapper>